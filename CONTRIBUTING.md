Contributing Guide
==================

Thanks for considering a contribution to AFS FastAPI! This guide ensures changes align with our **agricultural robotics standards** and **Test-First development methodology**.

## Development Methodology Overview

AFS FastAPI employs **Test-Driven Development (TDD)** for all synchronization infrastructure and maintains **professional quality standards** across the entire codebase.

**Key Principles:**
- **Test-First approach**: Write failing tests before implementation
- **Agricultural domain focus**: All code serves real-world farming automation
- **Distributed systems reliability**: Multi-tractor coordination requires bulletproof code
- **Educational excellence**: Code serves both functional and instructional purposes

## Quick Verification Checklist

Before opening a PR, please run through this comprehensive checklist:

### 0. Environment Sanity (pyenv)

- ✅ pyenv healthy: `pyenv --version` prints a version without errors
- ✅ Rehash clean: `pyenv rehash` runs with no warnings
- 🛠 If you see "shims isn't writable":
  - Run: `chmod u+rwx ~/.pyenv/shims && pyenv rehash`
  - Ensure `.bash_profile` contains only bash-safe init (no zsh-specific constructs):
    - `export PYENV_ROOT="$HOME/.pyenv"`
    - `[[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"`
    - `eval "$(pyenv init -)"`
    - Optionally, if the plugin is installed: `eval "$(pyenv virtualenv-init -)"`
  - Keep zsh-specific initialization in `~/.zshrc`/`~/.zprofile`, not in bash files.

### 1. Test-First Development Requirements

**For Synchronization Infrastructure** (vector clocks, CRDTs, message queuing):
- **✅ RED phase**: Write failing test describing agricultural robotics behavior
- **✅ GREEN phase**: Implement minimal code meeting performance and safety requirements
- **✅ REFACTOR phase**: Enhance code quality while maintaining test coverage
- **📚 Reference**: See `TDD_WORKFLOW.md` for complete methodology

**For General Development**:
- **✅ Add tests**: New behavior or edge cases must have test coverage
- **✅ Run full suite**: `python -m pytest tests/` (expect **817 tests** passing for agricultural robotics core)
- **✅ Zero regression**: All existing tests must continue passing

### 2. Code Quality Standards

- **✅ Linting**: `ruff check .` (must show zero warnings)
- **✅ Formatting**: `black --check .` and `ruff format --check .`
- **✅ Type checking**: `mypy .` (or `pyright` if preferred)
- **✅ Performance**: Distributed systems components must meet sub-millisecond requirements

### Schema Management

- **✅ `todos.json` Schema**: The JSON schema for `todos.json` is generated from `TypedDict` definitions in `afs_fastapi/todos/manager.py`.
  - **Action**: After modifying any `TypedDict` related to `todos.json` in `afs_fastapi/todos/manager.py`, you **MUST** re-run `scripts/generate_todos_schema.py` to update `.claude/todos_schema.json`.
  - **Purpose**: This ensures the schema remains synchronized with the data structure, providing consistent validation and initial file creation.

### 3. Agricultural Domain Compliance

- **✅ ISOBUS compatibility**: Code interfacing with equipment must support ISO 11783
- **✅ Safety standards**: Follow ISO 18497 safety requirements for multi-tractor operations
- **✅ Network resilience**: Handle intermittent rural connectivity scenarios
- **✅ Agricultural context**: All tests and code must reflect real farming operations

### 4. Documentation and API Standards

- **✅ API changes**: Update Pydantic response models and endpoint `response_model`
- **✅ README updates**: Reflect new capabilities and test statistics
- **✅ Documentation**: Do NOT hand-edit `docs/index.html` (it is generated by CI)
- **✅ Code documentation**: Include agricultural context in docstrings

### 5. Quality Assurance Validation

- **✅ Runtime verification**: Start API with `python -m afs_fastapi` and test endpoints
- **✅ Integration testing**: Verify multi-component interactions work correctly
- **✅ Performance testing**: Ensure distributed systems meet real-time requirements
- **✅ Educational value**: Code should serve learning objectives alongside functionality

### 6. Version and Release Management

- **✅ Version files**: Update `afs_fastapi/version.py` if changes merit a release
- **✅ Changelog**: Add entry to `CHANGELOG.md` describing changes
- **✅ Breaking changes**: Document any API or behavior changes clearly

## Development Standards and Guidelines

### Architecture Principles

**Domain vs Transport Separation:**
- **Core logic**: Keep business logic in plain Python classes with full type annotations
- **API boundaries**: Use Pydantic models for request/response serialization
- **Agricultural context**: All classes should reflect real-world farming operations

**Distributed Systems Architecture:**
- **Synchronization components**: Must use Test-First development methodology
- **Performance requirements**: Sub-millisecond operations for real-time coordination
- **Network resilience**: Handle intermittent rural connectivity gracefully
- **ISOBUS compliance**: Support ISO 11783 message constraints and timing

### Component Development Guidelines

**Equipment Interfaces:**
- **Standards compliance**: Full ISOBUS (ISO 11783) and Safety (ISO 18497) implementation
- **Backwards compatibility**: Maintain existing API contracts while adding features
- **Agricultural realism**: All operations must reflect actual farming equipment behavior

**Sensor Systems:**
- **Pluggable backends**: Implement `read(sensor_id)` interface for hardware abstraction
- **Vendor independence**: Avoid coupling monitors to specific hardware vendors
- **Production readiness**: Support both simulation and real hardware integration

**Testing Requirements:**
- **Comprehensive coverage**: All distributed systems components require full test suites
- **Agricultural scenarios**: Tests must validate real farming operation sequences
- **Performance validation**: Include timing and load testing for critical components
- **Educational value**: Tests should serve as learning examples for agricultural robotics

### Technology Standards

**Python Compatibility:**
- **Target version**: Python 3.12+ (as specified in pyproject.toml)
- **Modern features**: Use union types, pattern matching, and advanced type hints
- **Performance optimization**: Leverage Python 3.12+ performance improvements

**Code Quality:**
- **Zero warnings**: Maintain zero linting warnings across entire codebase
- **Type safety**: Complete type annotations with mypy strict mode compliance
- **Documentation**: Comprehensive docstrings with agricultural context

### Distributed Systems Contribution Requirements

**Vector Clocks and Synchronization:**
- **Test-First mandatory**: All synchronization code must follow Red-Green-Refactor
- **Performance validation**: Include sub-millisecond timing tests
- **Agricultural scenarios**: Test multi-tractor coordination use cases
- **Network failure handling**: Validate behavior under connectivity loss

**CRDT Implementation (Future):**
- **Conflict-free guarantee**: All CRDT implementations must mathematically guarantee convergence
- **Field operation context**: Focus on agricultural coordination problems
- **Documentation**: Include formal proofs or references for CRDT properties

**Message Queuing Systems:**
- **Guaranteed delivery**: Implement acknowledgment and retry mechanisms
- **ISOBUS constraints**: Respect ISO 11783 message size and timing limits
- **Agricultural protocols**: Support farm equipment communication patterns

## Documentation References

**Essential Reading for Contributors:**

- **TDD_WORKFLOW.md**: Complete Test-First development methodology guide (200+ lines)
  - Red-Green-Refactor cycle explanation with agricultural examples
  - Performance requirements and quality metrics
  - Distributed systems testing patterns

- **TDD_INTEGRATION.md**: Integration analysis and methodology best practices
  - How TDD integrates with existing 129-test architecture
  - Quality assurance framework
  - Educational framework preservation

- **WORKFLOW.md**: Authoritative testing reference and architecture guide
  - Complete test suite analysis (817 tests)
  - Professional agricultural testing patterns
  - Domain coverage and execution commands

- **SESSION_SUMMARY.md**: Project evolution and strategic direction
  - Complete development history and decisions
  - Strategic reasoning for Test-First approach
  - Future synchronization infrastructure roadmap

**Quick Reference Commands:**

```bash
# Run complete test suite (817 tests)
python -m pytest tests/ -v

# Check code quality (expect zero warnings)
ruff check .
black --check .
mypy .

# Test performance of distributed systems
python -c "
from afs_fastapi.services.synchronization import VectorClock
import time
clock = VectorClock(['tractor_001', 'tractor_002'])
start = time.perf_counter()
for _ in range(1000): clock.increment('tractor_001')
print(f'1000 ops in {(time.perf_counter() - start)*1000:.2f}ms')
"

# Start API for integration testing
python -m afs_fastapi
```

## Test-First Development Examples

**Example: Adding New Synchronization Component**

1. **RED Phase** - Write failing test in `tests/unit/services/`:
```python
def test_new_component_agricultural_behavior(self):
    """Test component handles multi-tractor field coordination."""
    # Test will fail initially - component doesn't exist yet
    component = NewSyncComponent(["tractor_001", "tractor_002"])
    result = component.coordinate_field_operation("section_A")
    self.assertTrue(result.is_safe_for_multi_tractor_access())
```

2. **GREEN Phase** - Implement minimal working code:
```python
class NewSyncComponent:
    def coordinate_field_operation(self, section):
        return SafeOperationResult(safe=True)  # Minimal implementation
```

3. **REFACTOR Phase** - Enhance while maintaining tests:
```python
class NewSyncComponent:
    def coordinate_field_operation(self, section):
        # Add real coordination logic, error handling, performance optimization
        # All while keeping the test passing
```

Version Management and Tagging Strategy
---------------------------------------

**🚨 CRITICAL: All contributors MUST follow this tagging strategy**

### Branch and Tagging Rules

This project uses **Git Flow** with strict tagging conventions:

#### Branches
- **`main`** - Stable releases only (production-ready)
- **`develop`** - Active development (all new work goes here)
- **Feature branches** - Branch from `develop`, merge back to `develop`

#### Tag Types and Rules

**1. Release Tags (Stable Production)**
- **Format**: `v{major}.{minor}.{patch}` (e.g., `v0.1.1`, `v0.1.6`)
- **Branch**: Only created on `main` branch
- **When**: After merging `develop` → `main` for stable releases
- **Who**: Only maintainers create release tags

**2. Alpha Tags (Development)**
- **Format**: `v{major}.{minor}.{patch}a{n}` (e.g., `v0.1.6a0`, `v0.1.6a1`)
- **Branch**: Only created on `develop` branch
- **When**: After significant development milestones
- **Sequence**: Must be sequential (a0 → a1 → a2, no gaps)

#### Version File Requirements

Before creating any tag, these files MUST be synchronized:
- `afs_fastapi/version.py` - Contains `__version__ = "0.1.6"`
- `pyproject.toml` - Contains `version = "0.1.6"`

**Version format**: Without 'v' prefix (tag: `v0.1.6`, files: `0.1.6`)

#### Contributor Guidelines

**✅ Contributors CAN:**
- Work on feature branches from `develop`
- Update version files in PRs that warrant a version bump
- Request alpha tags for significant milestones

**❌ Contributors MUST NOT:**
- Create any tags directly (maintainers only)
- Work directly on `main` branch
- Create release tags on `develop` branch
- Create alpha tags on `main` branch
- Skip version numbers or create gaps in alpha sequences

#### Tag Creation Examples (Maintainers Only)

```bash
# Alpha release on develop branch
git checkout develop
git tag -a v0.1.6a1 -m "Alpha release v0.1.6a1 - Added new monitoring features"
git push origin v0.1.6a1

# Stable release on main branch (after merging develop)
git checkout main
git merge develop
git tag -a v0.1.6 -m "Release v0.1.6 - Enhanced monitoring and bug fixes"
git push origin main
git push origin v0.1.6
```

#### Current Version Status

- **Latest Stable**: `v0.1.3` (on `main` branch) - **RELEASED 2025-09-28**
- **Current Development**: `v0.1.4+` (on `develop` branch)
- **Recent Major Achievement**: Complete Test-First development implementation with Vector Clock distributed systems
- **Next Evolution Focus**: CRDT implementation, enhanced ISOBUS messaging, fleet coordination systems

#### For Pull Requests

When submitting PRs:

1. **Target `develop` branch** (not `main`)
2. **Update version files** if your changes warrant a version bump:
   ```python
   # afs_fastapi/version.py
   __version__ = "0.1.6"  # Remove 'a0' when ready for next release
   ```
   ```toml
   # pyproject.toml
   version = "0.1.6"
   ```
3. **Update CHANGELOG.md** with your changes
4. **Let maintainers handle tagging** - don't create tags yourself

#### Enforcement

- GitHub Actions will validate version consistency
- PRs with incorrect version formats will be rejected
- Maintainers will create appropriate tags after PR merges
- Questions? Check project documentation (WORKFLOW.md, TDD_WORKFLOW.md, SESSION_SUMMARY.md) for detailed guidance

## Summary: Key Contribution Requirements

**Essential for All Contributors:**

1. **✅ Follow Test-First Development** for synchronization infrastructure
2. **✅ Maintain 817-test suite** with 100% pass rate and zero regression
3. **✅ Achieve zero linting warnings** across entire codebase
4. **✅ Include agricultural context** in all code and tests
5. **✅ Meet performance requirements** (sub-millisecond for distributed systems)
6. **✅ Update documentation** to reflect new capabilities
7. **✅ Target develop branch** for all pull requests

**For Distributed Systems Components:**
- **Mandatory TDD methodology** (Red-Green-Refactor)
- **ISOBUS compliance** (ISO 11783) where applicable
- **Network resilience** testing and validation
- **Educational value** alongside functional implementation

**Quality Gates:**
- All 161 tests passing in ~3 seconds
- Zero warnings from `ruff check .`
- Type safety with `mypy .`
- Performance validation for critical components

Thank you for contributing to AFS FastAPI's mission of advancing **enterprise-grade agricultural robotics** through **Test-First development** and **distributed systems excellence**!